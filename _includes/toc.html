{% comment %}
  Table of Contents and Word Count
  Generates a collapsible table of contents from page headings
  and displays the word count
{% endcomment %}

<aside class="sidebar__right">
  <nav class="toc">
    <header>
      <h4 class="nav__title"><i class="fas fa-{{ include.icon | default: 'file-alt' }}"></i> {{ include.title | default: site.data.ui-text[site.locale].toc_label | default: "On This Page" }}</h4>
    </header>
    <details id="toc-details" open>
      <summary>Table of Contents</summary>
      <ul class="toc__menu" id="markdown-toc">
        <!-- TOC will be generated here by JavaScript -->
      </ul>
    </details>
  </nav>
</aside>

<script>
(function() {
  'use strict';
  
  function initializeTOC() {
    try {
      // Generate table of contents
      var tocContainer = document.getElementById('markdown-toc');
      var headings = document.querySelectorAll('.page__content h2, .page__content h3, .page__content h4');
      var tocDetails = document.getElementById('toc-details');
      
      // Set initial state based on screen width
      if (tocDetails && window.innerWidth < 1200) {
        tocDetails.removeAttribute('open');
      }
      
      if (headings.length > 0 && tocContainer) {
        headings.forEach(function(heading, index) {
          // Create ID if doesn't exist
          if (!heading.id) {
            heading.id = 'heading-' + index;
          }
          
          // Create TOC entry
          var li = document.createElement('li');
          var a = document.createElement('a');
          a.href = '#' + heading.id;
          a.textContent = heading.textContent;
          
          // Add class based on heading level
          if (heading.tagName === 'H2') {
            li.className = 'toc-h2';
          } else if (heading.tagName === 'H3') {
            li.className = 'toc-h3';
          } else if (heading.tagName === 'H4') {
            li.className = 'toc-h4';
          }
          
          li.appendChild(a);
          tocContainer.appendChild(li);
        });
        
        // Smooth scrolling for TOC links
        var tocLinks = tocContainer.querySelectorAll('a');
        tocLinks.forEach(function(link) {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            var targetSelector = this.getAttribute('href');
            if (targetSelector) {
              var target = document.querySelector(targetSelector);
              if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          });
        });
      } else {
        // Hide TOC if no headings
        if (tocDetails) {
          tocDetails.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('Error initializing TOC:', error);
    }
  }
  
  // Initialize TOC when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTOC);
  } else {
    // DOM is already loaded
    initializeTOC();
  }
})();
</script>